---
title: "Reproducible research with workflowr"
subtitle: "workflowr version `r utils::packageVersion('workflowr')`"
author: "John Blischak"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Reproducible research with workflowr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

## Introduction

The [workflowr][] R package makes it easier for you to organize, reproduce, and
share your data analyses. This short tutorial will introduce you to the
workflowr framework. If you are completing this tutorial as part of a live
workshop, please follow the [setup instructions](#setup) in the next section prior to
arriving.

Workflowr combines literate programming with [R Markdown][rmd] and version
control with [Git][git] to generate a website containing time-stamped,
versioned, and documented results. By the end of this tutorial, you will have a
website hosted on [GitHub Pages][gh-pages] that contains the results of a
reproducible, statistical analysis.

[gh-pages]: https://pages.github.com/
[git]: https://git-scm.com/
[rmd]: http://rmarkdown.rstudio.com/
[workflowr]: https://github.com/jdblischak/workflowr

## Setup

1. Install [R][r]

1. Install [RStudio][rstudio]

1. Install workflowr from [CRAN][cran]:

    ```r
    install.packages("workflowr")
    ```

1. Create an account on [GitHub][gh]

[cran]: https://cran.r-project.org/package=workflowr
[gh]: https://github.com
[r]: http://cran.r-project.org
[rstudio]: https://www.rstudio.com/products/rstudio/download/

## Organized

To help you stay organized, workflowr creates a project directory with the
necessary configuration files as well as subdirectories for saving data and
other project files. This tutorial uses the [RStudio project
template][rstudio-proj-template] for workflowr, but note that the same can be
achieved via the function `wflow_start()`.

[rstudio-proj-template]: https://rstudio.github.io/rstudio-extensions/rstudio_project_templates.html

To start your workflowr project, follow these steps:

1. Open RStudio.

1. In the R console, run `wflow_git_config()` to register your name and email
with Git. This only has to be done once per computer. If you've used Git
on this machine before, you can skip this step. For a better GitHub experience,
use the same email as you used to register your GitHub account.

    ```{r config}
    library(workflowr)
    wflow_git_config(user.name = "First Last", user.email = "email@domain.com")
    ```

1. In the menu bar, choose `File` -> `New Project`.

1. Choose `New Directory` and then scroll down the list of project types to
select `workflowr project`.

    ![Screenshot of RStudio New Project menu](github-new-repo.png)

    ![Screenshot of Project type workflowr project](github-new-repo.png)

1. Type `myproject` as the directory name, choose where to save it on
your computer, and choose `Create Project`.

    ![Screenshot of workflowr project template menu](github-new-repo.png)

1. RStudio executed `wflow_start()` to create the workflowr project `myproject`
and opened the project in RStudio. Note the workflowr directory structure
in the Files pane.

    ```
    myproject/
    ├── .gitignore
    ├── .Rprofile
    ├── _workflowr.yml
    ├── analysis/
    │   ├── about.Rmd
    │   ├── index.Rmd
    │   ├── license.Rmd
    │   └── _site.yml
    ├── code/
    │   ├── README.md
    ├── data/
    │   └── README.md
    ├── docs/
    ├── myproject.Rproj
    ├── output/
    │   └── README.md
    └── README.md
    ```

1. Using the files pane, navigate to the directory `analysis/` and click on
`index.Rmd` to open it for editing. Write a short introductory message.

1. In the R console, run `wflow_build()`. This will build all the R Markdown
files in `analysis/`^[The default behavior when `wflow_build()` is run without
any arguments is to build any R Markdown file that has been edited since its
corresponding HTML file was last built.], save them in `docs/`, and then open
`docs/index.html` in the RStudio Viewer pane.

1. To perform your analysis, you will use a built-in data set from R.^[While not
the most exciting, this avoids any issues with downloading data from the
internet and saving it correctly.] The data set `ToothGrowth` contains the
length of the teeth for 60 guinea pigs given 3 different doses of vitamin C
either via orange juice (`OC`) or directly with ascorbic acid (`VC`). To
explore the data set, run the following in the R console.

    ```{r teeth, eval=TRUE}
    data("ToothGrowth")
    summary(ToothGrowth)
    str(ToothGrowth)
    ```

1. To mimic a real project that will have external data files, save the
`ToothGrowth` data set to the `data/` subdirectory using `write.csv()`.

    ```{r teeth-write}
    write.csv(ToothGrowth, file = "data/teeth.csv")
    ```

## Reproducible

To demonstrate the reproducibility features of workflowr, you will perform a
small analysis.

1. In the R console, open a new R Markdown file with `wflow_open()`. It will
open automatically for editing in RStudio.

    ```{r open-teeth}
    wflow_open("analysis/teeth.Rmd")
    ```

1. In the file `teeth.Rmd`, insert a code chunk^[You can insert a code chunk via
the menu bar, `Code` -> `Insert Chunk`, or using the keyboard shortcut
`Ctrl/Cmd`+`Alt`+`I`.] that imports the data set from the file you previously
created.

    ````
    ```{r import-teeth}`r ''`
    teeth <- read.csv("data/teeth.csv", row.names = 1)
    head(teeth)
    ```
    ````

1. In the file `teeth.Rmd`, insert a second chunk and create some boxplots to
explore the data:

    ````
    ```{r boxplots}`r ''`
    boxplot(len ~ dose, data = teeth)
    boxplot(len ~ supp, data = teeth)
    boxplot(len ~ dose + supp, data = teeth)
    ```
    ````

```{r test-boxplots, eval=TRUE, include=FALSE}
data("ToothGrowth")
teeth <- ToothGrowth
boxplot(len ~ dose, data = teeth)
boxplot(len ~ supp, data = teeth)
boxplot(len ~ dose + supp, data = teeth)
```

1. To compare the tooth length of the guinea pigs given orange juice versus
those given vitamin C, you could perform a [permutation-based statistical test][permutation].
This involves comparing the observed difference in teeth length due to the
supplement method to the observed differences calculated from random
permutations of the data. The basic idea is that if the observed difference is
an outlier compared to the differences generated after permuting the supplement
method column, it is more likely to be a true signal not due to chance alone.
Insert the code chunk below to demonstrate a permutation^[You won't implement
the full permutation method in this tutorial.]:

[permutation]: https://en.wikipedia.org/wiki/Resampling_%28statistics%29#Permutation_tests

    ````
    ```{r permute}`r ''`
    # Observed difference in teeth length due to supplement method
    mean(teeth$len[teeth$supp == "OJ"]) - mean(teeth$len[teeth$supp == "VC"])
    # Permute the observations
    supp_perm <- sample(teeth$supp)
    # Caclculate mean difference in permuted data
    mean(teeth$len[supp_perm == "OJ"]) - mean(teeth$len[supp_perm == "VC"])
    ```
    ````

```{r test-permute, eval=TRUE, include=FALSE}
# Observed difference in teeth length due to supplement method
mean(teeth$len[teeth$supp == "OJ"]) - mean(teeth$len[teeth$supp == "VC"])
# Permute the observations
supp_perm <- sample(teeth$supp)
# Caclculate mean difference in permuted data
mean(teeth$len[supp_perm == "OJ"]) - mean(teeth$len[supp_perm == "VC"])
```

1. In the R console, run `wflow_build()`. Note the value of the observed difference
in the permuted data.

1. In RStudio, click on the Knit button. Has the value of the observed difference
in the permuted data changed? It should be identical. This is because workflowr
always sets the same seed prior to running the analysis.^[Note that everyone in
the workshop will have the same result because by default workflowr uses a seed that
is the date the project was created as YYYYMMDD. You can change this by editing
the file `_workflowr.yml`.]

1. Navigate to the file `analysis/index.Rmd`. It should already be open in the
RStudio Editor pane from when you created the project. If not, you can click on
it in the Files pane or run the following in the R console:

    ```{r open-index}
    wflow_open("analysis/index.Rmd")
    ```

1. Copy-paste the line below into `analysis/index.Rmd`. This creates a
hyperlink to the tooth analysis. The text between the square brackets is
displayed on the webpage, and the text in parentheses is the relative path to
the teeth webpage. Note that you don't need to include the subdirectory `docs/`
because `index.html` and `teeth.html` are both already in `docs/`. Also note
that you need to use the file extension `.html` since that is the file that
needs to be opened by the web browser.

    ```
    * [Teeth growth](teeth.html)
    ```

1. Run `wflow_build()` and then confirm that clicking on the link "Teeth growth"
takes you to your teeth analysis page.

1. In the R console, run `wflow_status()`. This will show you the status of each
of the Rmd files in your workflowr project. The status is determined by the Git
status of the Rmd file and its corresponding HTML file. The file `teeth.Rmd` is
classified as "Scratch" because it has not yet been committed (i.e. saved in a
snapshot). In contrast, the file `index.Rmd` has status "Unpublished" because
the Rmd file has been committed (an initial commit was made when the project was
first started) but not its corresponding HTML file.

<!-- Use knitr::include_graphics() to insert PNG version of image -->

1. In the R console, run the command below to "publish" your results. The function
`wflow_publish()` performs three steps: 1) commits the files, 2) rebuilds the
Rmd files, and 3) commits the HTML and figure files. This guarantees that the
results in each HTML file is always generated from an exact, known version
of the Rmd file (you can see this version embedded in the workflowr report).
The second argument is the message that is associated with the Git commit.
This way you can better understand the motivation for each change that you
made when you review the development history of your project (e.g. with `git log`).

    ```{r publish-teeth-growth}
    wflow_publish(c("analysis/*Rmd", "data/teeth.csv"), "Analyze teeth growth")
    ```

1. Open the workflowr report of `teeth.html` by clicking on the button at the
top of the page. Navigate to the tab "Past versions". Note that the record
of all past versions will be saved here. Once the project has been added to
GitHub (you will do this in the next section), the "Past versions" tab will
include hyperlinks for convenient viewing of the past versions of the Rmd and
HTML files.

## Shareable

To share your work, you will host the Git repository on GitHub and activate the
free service GitHub Pages to serve the static website in `docs/`.

1. In the R console, run the function `wflow_use_github()`. The only required
argument is your GitHub username. The name of the repository will automatically
be named the same as the directory containing the workflowr project, in this
case "myproject". When the function asks if you would like it to create the
repository on GitHub for you, enter `y` for "yes". This will open your web
browser so that you can authenticate with GitHub and then give permission for
workflowr to create the repository on your behalf. Additionally, this function
connects to your local repository with the remote GitHub repository and
inserts a link to the GitHub repository into the navigation bar.

    ```{r wflow-use-github}
    wflow_use_github("your-github-username")
    ```

1. To update your workflowr website to use GitHub links to past versions of the
files (as well as update the navigation bar to include the GitHub link),
republish the files.

    ```{r republish}
    wflow_publish(republish = TRUE)
    ```

1. To send your project to GitHub, run `wflow_git_push()`. This will prompt you
for your GitHub username and password.

    ```{r wflow-git-push}
    wflow_git_push()
    ```

1. On GitHub, navigate to the Settings tab of your GitHub repository. Scroll
down to the section "GitHub Pages". For Source choose "master branch /docs folder".
After it updates, scroll back down and click on the URL.

1. Navigate to the tooth analysis. Click on the links in the "Past versions"
tab to see the past results.

## Troubleshooting

1. I don't see the workflowr project as an available RStudio Project Type.

    If you just installed workflowr, close and re-open RStudio.
    Also, make sure you scroll down to the bottom of the list.

1. The GitHub repository wasn't created automatically by `wflow_use_github()`.

    If `wflow_use_github()` failed unexpectedly when creating the GitHub
    repository, or if you declined by entering `n`, you can     manually created
    the repository on GitHub. After logging in to GitHub, click on the "+" in
    the top right of the page. Choose "New repository". For the repository name,
    type `myproject`. Do not change any of the     other settings. Click on the
    green button "Create repository". Once that is completed, you can return to
    the next step in the tutorial.

    ![Screenshot of RStudio New Project menu](github-new-repo.png)

1. I wasn't able to push to GitHub with `wflow_git_push()`.

    Unfortunately this function has a high failure rate because it relies on the
    correct configuration of various system software dependencies. If this fails,
    you can push to Git using another techinque, but this will require that you
    have previously installed Git on your computer. For example, you can use the
    RStudio Git pane (click on the green arrow that says "Push"). Alternatively,
    you can directly use Git by running `git push` in the terminal.

1. My website isn't displaying after I activated GitHub Pages.

It is not uncommon for there to be a short delay before your website is
available. One trick to try is to specify the exact page that you want at the
end of the URL, e.g. add `/index.html` to the end of the URL.
